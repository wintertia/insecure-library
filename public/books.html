<!DOCTYPE html>
<html>
<head>
    <title>Library Books</title>
</head>
<body>
    <h1>Library Management System</h1>
    
    <div id="userInfo"></div>
    
    <div>
        <label for="searchInput">Search Books:</label>
        <input type="text" id="searchInput" placeholder="Enter title or author">
        <button onclick="searchBooks()">Search</button>
        <button onclick="loadAllBooks()">Show All Books</button>
        <button onclick="logout()">Logout</button>
    </div>
    
    <div id="adminControls" style="display: none;">
        <h3>Admin Controls</h3>
        <form id="addBookForm">
            <input type="text" id="newTitle" placeholder="Title" required>
            <input type="text" id="newAuthor" placeholder="Author" required>
            <input type="text" id="newIsbn" placeholder="ISBN">
            <input type="number" id="newYear" placeholder="Year">
            <input type="text" id="newDescription" placeholder="Description">
            <button type="submit">Add Book</button>
        </form>
    </div>
    
    <div id="results">
        <h3>Search Results:</h3>
        <table border="1" id="resultsTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Author</th>
                    <th>ISBN</th>
                    <th>Year</th>
                    <th>Description</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="resultsBody">
            </tbody>
        </table>
    </div>

    <script>
        let currentUser = null;
        
        // Check if user is logged in
        function checkAuth() {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = '/login';
                return;
            }
            
            currentUser = JSON.parse(userStr);
            document.getElementById('userInfo').innerHTML = 
                '<p>Logged in as: <strong>' + currentUser.username + '</strong> (Role: ' + currentUser.role + ', ID: ' + currentUser.id + ')</p>';
            
            if (currentUser.role === 'admin') {
                document.getElementById('adminControls').style.display = 'block';
            }
        }
        
        // Search books function
        async function searchBooks() {
            const query = document.getElementById('searchInput').value;
            
            try {
                const response = await fetch('/api/search?q=' + encodeURIComponent(query));
                const results = await response.json();
                
                if (response.ok) {
                    displayResults(results);
                } else {
                    document.getElementById('resultsBody').innerHTML = 
                        '<tr><td colspan="7" style="color: red;">Error: ' + (results.error || 'Search failed') + '</td></tr>';
                }
            } catch (error) {
                document.getElementById('resultsBody').innerHTML = 
                    '<tr><td colspan="7" style="color: red;">Error: ' + error.message + '</td></tr>';
            }
        }
        
        // Load all books
        async function loadAllBooks() {
            document.getElementById('searchInput').value = '';
            await searchBooks();
        }
        
        // Display search results
        function displayResults(results) {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';
            
            if (results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">No results found</td></tr>';
                return;
            }
            
            results.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.id || ''}</td>
                    <td>${result.title || ''}</td>
                    <td>${result.author || ''}</td>
                    <td>${result.isbn || ''}</td>
                    <td>${result.year || ''}</td>
                    <td>${result.description || ''}</td>
                    <td>
                        ${currentUser && currentUser.role === 'admin' ? 
                            '<button onclick="deleteBook(' + result.id + ')">Delete</button>' : 
                            'N/A'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Add book (admin only)
        document.getElementById('addBookForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const bookData = {
                title: document.getElementById('newTitle').value,
                author: document.getElementById('newAuthor').value,
                isbn: document.getElementById('newIsbn').value,
                year: parseInt(document.getElementById('newYear').value) || null,
                description: document.getElementById('newDescription').value,
                userId: currentUser.id
            };
            
            try {
                const response = await fetch('/api/books', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(bookData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Book added successfully!');
                    document.getElementById('addBookForm').reset();
                    loadAllBooks();
                } else {
                    alert('Error adding book: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });
        
        // Delete book (admin only)
        async function deleteBook(bookId) {
            if (!confirm('Are you sure you want to delete this book?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/books/' + bookId, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ userId: currentUser.id })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Book deleted successfully!');
                    loadAllBooks();
                } else {
                    alert('Error deleting book: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        // Logout function
        function logout() {
            localStorage.removeItem('user');
            window.location.href = '/login';
        }
        
        // Search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchBooks();
            }
        });
        
        // Initialize page
        checkAuth();
        loadAllBooks();
    </script>
</body>
</html>